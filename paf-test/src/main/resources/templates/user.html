<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <title>Document</title>
</head>
<body>
    <div class="container-fluid text-center">
        <h2>To-do List</h2>
    </div>

    <div class="container-fluid">
        <form action="/tasks" method="get">
            <div class="row">
                <div class="col">Username</div>
            </div>
            <div class="row">
                <div class="col"><input type="text" name="username" id="username" data-th-value="${username}"></div>
            </div>
        </form>
    </div> 
    
    <hr>
    <form data-th-action="@{/tasks/{username}/save(username=${user.username})}" method="post">
        <div class="container-fluid" id="formInput">
            <div class="row">
                <div class="col-sm-1"><button type="submit" class="btn btn-primary">Save</button></div>
                <div class="col-sm-1"><button type="button" class="btn btn-primary" id="rowAdder">Add Task</button></div>
            </div>
            <div class="row">
                <div class="col-sm">Description</div>
                <div class="col-sm">Priority</div>
                <div class="col-sm">Due Date</div>
                <div class="col-sm"></div>
            </div>
            <div data-th-unless="${user.getUserId == null}" class="row" data-th-each="task : ${user.taskList}">
                <div class="col-sm"><input type="text" name="description" data-th-value="${task.description}"></div>
                <div class="col-sm"><input type="text" name="priority" data-th-value="${task.priority}"></div>
                <div class="col-sm"><input type="date" name="dueDate" data-th-value="${task.dueDate}"></div>
                <div class="col-sm">
                    <input type="hidden" name="taskId" data-th-value="${task.taskId}">
                    <a data-th-href="@{/tasks/{username}/delete/{taskId}(username=${user.username}, taskId=${task.taskId})}">
                        <button type="button" data-th-id="'deleteRowBtn' + ${task.taskId}" class="btn btn-primary">x</button>
                    </a>
                </div>
            </div>
        </div>
    </form>

    <hr>

    <div class="container-fluid">
        <a href="/">Home</a>
    </div>
</body>
</html>
<script>
    $("#username").focus(function () {
      $(this).mouseleave(function () {
        var str = $("#username").val();
        console.log("leaving...");
        if (str != null) location.href = "/tasks/" + str;
        $(this).off();
      });
    });

    $("#rowAdder").click(function () {
        newRowAdd = 
            '<div class="row"> <div class="col-sm">' +
            '<input type="text" name="description"> </div>' +
            '<div class="col-sm"> <input type="text" name="priority">' +
            '</div> <div class="col-sm"> <input type="date" name="dueDate">' +
            '</div> <div class="col-sm"> <input type="hidden" name="taskId" data-th-value="${task.taskId} + ${1}">' +
            '<form data-th-action="@{/tasks/{username}/delete/{taskId}(username=${user.username}, taskId=${task.taskId})}" method="post"> ' +
            '<button type="submit" data-th-id="\'deleteRowBtn\' + ${task.taskId}" class="btn btn-primary">x</button></form> </div> </div>';
        
        $('#formInput').append(newRowAdd);
    });
</script>